<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>Marcela & Alana ‚Äî Sintonize nossa vibe üé∂</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .ui { position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 500px at 50% 100%, rgba(0,0,0,.55), rgba(0,0,0,.9));
      z-index:10; color:#fff; text-align:center; padding:24px; }
    .ui.hidden { display:none; }
    .card { max-width:420px; width:92%; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px; backdrop-filter:blur(6px);
      box-shadow:0 12px 30px rgba(0,0,0,.35); }
    .title { font-weight:700; font-size:1.1rem; margin-bottom:8px; }
    .btn { margin-top:12px; padding:12px 16px; border:0; border-radius:12px; background:#21d4a3; color:#071b16; font-weight:700; width:100%; }
    .hint { font-size:.9rem; opacity:.85; line-height:1.35; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:#0df; color:#002; font-weight:700; font-size:.8rem; margin-bottom:10px; }
    .watermark { position:fixed; left:12px; bottom:10px; color:#9be8dc; font-weight:700; font-size:.9rem; letter-spacing:.2px; opacity:.9; z-index:5; text-shadow:0 2px 10px rgba(0,0,0,.5); }
    .status { position:fixed; right:12px; bottom:10px; z-index:11;
      background:rgba(0,0,0,.55); color:#9be8dc; padding:8px 10px; border-radius:10px; font-weight:700; }

    /* Controles +/‚àí de tamanho */
    .sizebar{position:fixed;top:12px;right:12px;z-index:11;display:flex;gap:8px}
    .sizebar button{padding:8px 10px;border-radius:10px;border:0;background:#21d4a3;color:#071b16;font-weight:700}
  </style>
</head>
<body>
  <!-- Overlay / instru√ß√µes -->
  <div id="overlay" class="ui">
    <div class="card">
      <div class="badge">Sintonize nossa vibe üé∂</div>
      <div class="title">Aponte a c√¢mera para o marcador</div>
      <div class="hint">
        Toque em ‚ÄúAbrir c√¢mera‚Äù. Se n√£o pedir permiss√£o, use o √≠cone ao lado da URL e <b>permita a c√¢mera</b>.<br/>
        Se <code>targets/bracelet.mind</code> n√£o existir, abriremos um marcador de teste automaticamente.
      </div>
      <button id="startBtn" class="btn">Abrir c√¢mera</button>
    </div>
  </div>

  <div class="watermark">Marcela & Alana ‚Äî 16</div>
  <div id="status" class="status">Procurando marcador‚Ä¶</div>

  <!-- Bot√µes de tamanho -->
  <div class="sizebar">
    <button id="smaller">‚Äì</button>
    <button id="bigger">+</button>
  </div>

  <!-- Cena (sem mindar-image; definimos via JS ap√≥s checar o .mind) -->
  <a-scene id="scene"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; alpha: true"
    embedded>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-assets timeout="120000">
      <!-- Mantenha o v√≠deo em H.264/AAC. Se for 9:16, ajustamos automaticamente. -->
      <video id="clip" src="./assets/clipe.mp4" crossorigin="anonymous"
             preload="auto" webkit-playsinline playsinline muted loop></video>
    </a-assets>

    <a-entity id="target" mindar-image-target="targetIndex: 0">
      <!-- Usamos a-plane com textura de v√≠deo: mais compat√≠vel que <a-video> em alguns Androids -->
      <a-plane id="videoPlane"
        geometry="width: 0.32; height: 0.18"  <!-- base 16:9; ser√° recalculado pelo JS -->
        position="0 0 0.05"
        rotation="0 0 0"
        material="src: #clip; shader: flat; side: double">
      </a-plane>
    </a-entity>
  </a-scene>

  <script>
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('clip');
    const scene = document.getElementById('scene');
    const targetEntity = document.getElementById('target');
    const statusEl = document.getElementById('status');
    const plane = document.getElementById('videoPlane');

    // Caminhos do alvo (.mind)
    const LOCAL_MIND = './targets/bracelet.mind';
    const FALLBACK_MIND = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/samples/assets/card-example/card.mind';
    const FALLBACK_MARKER = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/samples/assets/card-example/card.png';

    // Tamanho base (ajustaremos ao carregar os metadados do v√≠deo)
    let baseW = 0.32, baseH = 0.18; // 16:9
    let scale = 1.7;                // come√ßa maior (1.0 = base)

    function applySize() {
      plane.setAttribute('geometry', `width: ${(baseW*scale).toFixed(3)}; height: ${(baseH*scale).toFixed(3)}`);
    }

    // Se o clipe for vertical (9:16), invertemos a base
    video.addEventListener('loadedmetadata', () => {
      if (video.videoHeight > video.videoWidth) {
        baseW = 0.18; baseH = 0.32; // 9:16
      } else {
        baseW = 0.32; baseH = 0.18; // 16:9
      }
      applySize();
    });

    // 1) Permiss√£o de c√¢mera
    async function ensureCameraPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } }, audio: false
        });
        stream.getTracks().forEach(t => t.stop()); // libera: MindAR abre depois
        return true;
      } catch (e) {
        alert('N√£o consegui abrir a c√¢mera.\nNo Chrome: √≠cone ao lado da URL ‚Üí Permiss√µes ‚Üí C√¢mera: Permitir. Depois recarregue.');
        return false;
      }
    }

    // 2) Checa se o .mind local existe; se n√£o, usa o de exemplo
    async function chooseMind() {
      try {
        const res = await fetch(LOCAL_MIND, { method: 'HEAD', cache: 'no-store' });
        if (res.ok) return { url: LOCAL_MIND, isFallback: false };
      } catch (e) {}
      return { url: FALLBACK_MIND, isFallback: true };
    }

    // Indicador de tracking
    targetEntity.addEventListener('targetFound', () => { if (statusEl) statusEl.textContent = 'Alvo detectado ‚úÖ'; });
    targetEntity.addEventListener('targetLost',  () => { if (statusEl) statusEl.textContent = 'Procurando marcador‚Ä¶'; });

    // Controles de tamanho
    document.getElementById('bigger').onclick = () => { scale = Math.min(3, scale + 0.1); applySize(); };
    document.getElementById('smaller').onclick = () => { scale = Math.max(0.4, scale - 0.1); applySize(); };

    // Bot√£o principal
    startBtn.addEventListener('click', async () => {
      const ok = await ensureCameraPermission();
      if (!ok) return;

      const picked = await chooseMind();
      scene.setAttribute(
        'mindar-image',
        `imageTargetSrc: ${picked.url}; filterMinCF:0.0001; filterBeta:0.001; maxTrack:1`
      );

      try { await video.play(); } catch(e) {}
      overlay.classList.add('hidden');

      if (picked.isFallback) {
        setTimeout(() => window.open(FALLBACK_MARKER, '_blank'), 600);
      }
    });

    // Primeiro toque desmuta o √°udio (regras mobile)
    document.addEventListener('click', () => {
      if (video.muted) {
        video.muted = false;
        video.play().catch(()=>{});
      }
    });

    // Mensagens √∫teis do MindAR
    scene.addEventListener('arError', () => {
      alert('Falha ao iniciar AR. Abra no Chrome/Safari e permita a c√¢mera nas permiss√µes. Feche outros apps que usam a c√¢mera (WhatsApp/Meet/C√¢mera).');
    });
    scene.addEventListener('arReady', () => {
      console.log('MindAR pronto');
    });
  </script>
</body>
</html>



